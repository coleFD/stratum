# This job will auto detect changes in crates and auto bump the patch versions if changes are detected, and push to 
# the bot/versioning branch.
# Since cargo-smart-release does not yet support autodetection of MAJOR and MINOR changes with regards to Semver,
# any MAJOR/MINOR versioning will need to be manually changed in the package Cargo.toml.

on:
  push:
    branches: [ main ]

name: publish crate updates

jobs:
  autoversion:
    name: Autoversion
    if: github.pusher != 'GitHub <noreply@github.com>'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: 
          - ubuntu-latest
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl

    steps:
      - uses: actions/checkout@v3
      
        with:
          fetch-depth: 0
      
      - name: setup git config
        run: |
          # setup the username and email. I tend to use 'GitHub Actions Bot' with no email by default
          git config user.name "GitHub Actions Bot"
          git config user.email "<>"

      # cargo-smart-release requires at least one object in the .git/objects database to detect changes
      - name: Fetch
        run: git commit --allow-empty -m 'empty version commit'

      - name: Install cargo-smart-release
        run: cargo install cargo-smart-release

      # only autobump versions 
      - name: Commit version updates
        run: sh ./sv2-publish.sh -e -u --no-publish --no-push --no-changelog
      
      - name: Rebase
        run: git rebase origin/main

      - name: Push version updates to main
        run: git push -f --no-verify origin main:bot/versioning

      - name: Create pull request
        uses: peter-evans/create-pull-request@v4
        with:
          base: main
          branch: bot/versioning
          

    


        
